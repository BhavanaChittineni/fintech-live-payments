USE ROLE ACCOUNTADMIN; -- privileges
USE WAREHOUSE FINTECH_WH; -- compute
USE DATABASE FINTECH_DB; -- your DB
CREATE SCHEMA IF NOT EXISTS SILVER; -- clean layer

--PHASE 1 â€” SILVER (clean/deduped base view)
CREATE OR REPLACE VIEW FINTECH_DB.SILVER.V_TRANSACTIONS_CLEAN AS SELECT TXN_ID, TXN_TS_UTC, TO_DATE(TXN_TS_UTC) AS TXN_DATE, DATE_TRUNC('minute', TXN_TS_UTC) AS TXN_MINUTE, REGION, MERCHANT, CUSTOMER_ID, PAYMENT_METHOD, CURRENCY, AMOUNT_USD::NUMBER(12,2) AS AMOUNT_USD, IFF(IS_REFUND, -ABS(AMOUNT_USD), AMOUNT_USD) AS AMOUNT_NET_USD, STATUS, IFF(STATUS='APPROVED',1,0) AS IS_APPROVED_INT, IFF(STATUS='DECLINED',1,0) AS IS_DECLINED_INT, INGESTED_AT FROM ( SELECT t.*, ROW_NUMBER() OVER (PARTITION BY TXN_ID ORDER BY INGESTED_AT DESC) AS rn FROM FINTECH_DB.RAW.TRANSACTIONS_RAW t ) d WHERE rn=1 AND TXN_ID IS NOT NULL; -- dedupe + enrich

--Verify
SELECT COUNT(*) AS rows_silver FROM FINTECH_DB.SILVER.V_TRANSACTIONS_CLEAN; -- should grow with RAW
SELECT * FROM FINTECH_DB.SILVER.V_TRANSACTIONS_CLEAN ORDER BY INGESTED_AT DESC LIMIT 10; -- newest clean rows
