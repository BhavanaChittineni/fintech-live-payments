USE ROLE ACCOUNTADMIN; -- privileges
USE WAREHOUSE FINTECH_WH; -- compute
USE DATABASE FINTECH_DB; -- your DB
CREATE SCHEMA IF NOT EXISTS GOLD; -- KPI layer

-----PHASE 2 â€” GOLD KPIs (two core views you described)
--A) KPIs for last 60 minutes (cards)
CREATE OR REPLACE VIEW FINTECH_DB.GOLD.V_KPIS_60M AS SELECT COUNT(*) AS txn_count_60m, SUM(AMOUNT_USD) AS amount_total_usd_60m, SUM(AMOUNT_NET_USD) AS amount_net_usd_60m, AVG(AMOUNT_USD) AS avg_ticket_usd_60m, SUM(IS_APPROVED_INT) AS approved_txns_60m, SUM(IS_DECLINED_INT) AS declined_txns_60m, SUM(IFF(STATUS='REFUNDED',1,0)) AS refunds_cnt_60m, IFF(COUNT(*)=0,0, SUM(IFF(STATUS='REFUNDED',1,0))/COUNT(*)) AS refund_rate_60m, IFF(COUNT(*)=0,0, SUM(IS_DECLINED_INT)/COUNT(*)) AS decline_rate_60m, MIN(INGESTED_AT) AS window_start_utc, MAX(INGESTED_AT) AS window_end_utc FROM FINTECH_DB.SILVER.V_TRANSACTIONS_CLEAN WHERE INGESTED_AT >= DATEADD('minute', -60, CURRENT_TIMESTAMP());

--B) Revenue per minute (last 24h) (line chart)
CREATE OR REPLACE VIEW FINTECH_DB.GOLD.V_REVENUE_PER_MINUTE_24H AS SELECT TXN_MINUTE, SUM(AMOUNT_NET_USD) AS amount_net_usd, COUNT(*) AS txn_count FROM FINTECH_DB.SILVER.V_TRANSACTIONS_CLEAN WHERE TXN_TS_UTC >= DATEADD('hour', -24, CURRENT_TIMESTAMP()) GROUP BY TXN_MINUTE ORDER BY TXN_MINUTE;

--c)Merchant per minute (last 24h) 
CREATE OR REPLACE VIEW FINTECH_DB.GOLD.V_MERCHANT_MINUTE_24H AS SELECT MERCHANT, TXN_MINUTE, SUM(AMOUNT_NET_USD) AS amount_net_usd, COUNT(*) AS txn_count FROM FINTECH_DB.SILVER.V_TRANSACTIONS_CLEAN WHERE TXN_TS_UTC >= DATEADD('hour', -24, CURRENT_TIMESTAMP()) GROUP BY MERCHANT, TXN_MINUTE;

--c)Region per minute (last 24h) 
CREATE OR REPLACE VIEW FINTECH_DB.GOLD.V_REGION_MINUTE_24H AS SELECT REGION, TXN_MINUTE, SUM(AMOUNT_NET_USD) AS amount_net_usd, COUNT(*) AS txn_count FROM FINTECH_DB.SILVER.V_TRANSACTIONS_CLEAN WHERE TXN_TS_UTC >= DATEADD('hour', -24, CURRENT_TIMESTAMP()) GROUP BY REGION, TXN_MINUTE;

--Verify
SELECT * FROM FINTECH_DB.GOLD.V_KPIS_60M; -- KPI numbers should change as data flows
SELECT * FROM FINTECH_DB.GOLD.V_REVENUE_PER_MINUTE_24H ORDER BY TXN_MINUTE DESC LIMIT 10; -- latest minute buckets

